# eHazira Mobile App - Development Guide

## Table of Contents

1. [Recommended Approach](#1-recommended-approach)
2. [Do You Need to Rewrite Code?](#2-do-you-need-to-rewrite-code)
3. [Project Structure](#3-project-structure)
4. [Prerequisites & Setup on Mac](#4-prerequisites--setup-on-mac)
5. [Step-by-Step: Adding Capacitor](#5-step-by-step-adding-capacitor)
6. [Native API Migrations](#6-native-api-migrations)
7. [Testing on Mac](#7-testing-on-mac)
8. [Platform-Specific Considerations](#8-platform-specific-considerations)
9. [Building for Production](#9-building-for-production)
10. [Common Issues & Troubleshooting](#10-common-issues--troubleshooting)

---

## 1. Recommended Approach

**Use Capacitor** (by the Ionic team) to wrap the existing React web app into native iOS and Android apps.

### Why Capacitor over alternatives?

| Approach | Code Reuse | Effort | Native Feel | Recommendation |
|----------|-----------|--------|-------------|----------------|
| **Capacitor** | ~99% | Low | Good (WebView + native plugins) | **Recommended** |
| React Native | ~30-40% | High | Excellent | Overkill for this app |
| Flutter | 0% (full rewrite) | Very High | Excellent | Not practical |
| PWA | 100% | Very Low | Limited (no App Store) | Fallback option |

**Why Capacitor wins for eHazira:**

- The app is form-based UI (attendance, OTP entry, dashboards) — no complex animations or heavy graphics that would need truly native rendering.
- Every native API currently used has a direct Capacitor plugin (Geolocation, Push Notifications, Device Info).
- Same codebase, same project folder. No separate repository needed.
- Vite is fully supported by Capacitor.
- Full App Store and Play Store distribution.

---

## 2. Do You Need to Rewrite Code?

**No.** The existing React + TypeScript codebase will work as-is inside Capacitor with minor modifications:

### What stays the same (99% of the code)
- All React components (teacher screens, student screens, admin screens)
- All API service calls (`api.ts`)
- All state management (Zustand stores)
- All UI (Tailwind CSS, Radix UI components)
- React Router navigation
- TanStack Query data fetching

### What needs small changes
| Feature | Current (Web) | Mobile (Capacitor) | Change Required |
|---------|---------------|---------------------|-----------------|
| GPS/Geolocation | `navigator.geolocation` | `@capacitor/geolocation` plugin | Wrapper function (~10 lines) |
| Device UUID | `crypto.randomUUID()` + localStorage | `@capacitor/device` plugin | Wrapper function (~10 lines) |
| Device Fingerprint | Browser APIs (userAgent, screen) | `@capacitor/device` plugin | Wrapper function (~15 lines) |
| Google Sign-In | Firebase `signInWithPopup` | `@codetrix-studio/capacitor-google-auth` | Different auth flow on mobile |
| Push Notifications | Not implemented | `@capacitor/push-notifications` | New feature (optional) |
| WebSocket | Browser `WebSocket` | Works as-is in Capacitor | No change needed |
| localStorage | Browser localStorage | Works as-is in Capacitor | No change needed |
| HTTP requests (Axios) | Browser fetch/XHR | Works as-is in Capacitor | No change needed |
| Deep links | N/A | `@capacitor/app` plugin | New feature (optional) |

**Estimated files to modify: 3-4 files.** Everything else works without changes.

---

## 3. Project Structure

**No new project needed.** Capacitor lives inside the existing `ehazira-frontend` project.

After setup, the folder structure will look like:

```
ehazira-frontend/
├── android/                  # Auto-generated Android project (Android Studio)
│   ├── app/
│   │   ├── src/main/
│   │   │   ├── AndroidManifest.xml
│   │   │   ├── java/...
│   │   │   └── res/...
│   │   └── build.gradle
│   └── capacitor.settings.gradle
├── ios/                      # Auto-generated iOS project (Xcode)
│   ├── App/
│   │   ├── App/
│   │   │   ├── AppDelegate.swift
│   │   │   ├── Info.plist
│   │   │   └── capacitor.config.json
│   │   └── App.xcodeproj
│   └── Podfile
├── src/                      # Existing React source (unchanged)
│   ├── components/
│   ├── services/
│   ├── store/
│   └── ...
├── capacitor.config.ts       # Capacitor configuration
├── package.json              # Updated with Capacitor deps
├── vite.config.ts            # Unchanged
└── ...
```

The `android/` and `ios/` folders are generated by Capacitor and contain the native project shells. Your actual app code remains in `src/`.

---

## 4. Prerequisites & Setup on Mac

### Required Software

#### For Both Platforms
| Software | Purpose | Install Command |
|----------|---------|-----------------|
| Node.js 18+ | Runtime | `brew install node` |
| npm or yarn | Package manager | Comes with Node |
| Capacitor CLI | Mobile tooling | `npm install @capacitor/cli` (project-local) |

#### For iOS Development
| Software | Purpose | Install |
|----------|---------|---------|
| **Xcode** (required) | iOS build & simulator | Mac App Store (free, ~12 GB) |
| Xcode Command Line Tools | Build tools | `xcode-select --install` |
| CocoaPods | iOS dependency manager | `sudo gem install cocoapods` |

After installing Xcode, open it once and accept the license agreement. Then install iOS simulators:
`Xcode > Settings > Platforms > + > iOS 17` (or latest)

#### For Android Development
| Software | Purpose | Install |
|----------|---------|---------|
| **Android Studio** (required) | Android build & emulator | https://developer.android.com/studio (free) |
| Java 17 JDK | Build requirement | `brew install openjdk@17` |

After installing Android Studio:
1. Open Android Studio > More Actions > SDK Manager
2. Install: Android SDK 34 (or latest), Android SDK Build-Tools, Android Emulator, Android SDK Platform-Tools
3. Create an emulator: Tools > Device Manager > Create Device > Choose Pixel 7 > Select system image > Finish

#### Environment Variables (add to `~/.zshrc`)
```bash
# Android SDK
export ANDROID_HOME=$HOME/Library/Android/sdk
export PATH=$PATH:$ANDROID_HOME/emulator
export PATH=$PATH:$ANDROID_HOME/platform-tools
export PATH=$PATH:$ANDROID_HOME/tools
export PATH=$PATH:$ANDROID_HOME/tools/bin

# Java
export JAVA_HOME=$(/usr/libexec/java_home -v 17)
```

Run `source ~/.zshrc` after adding these.

---

## 5. Step-by-Step: Adding Capacitor

Run all commands from the `ehazira-frontend/` directory.

### Step 1: Install Capacitor

```bash
npm install @capacitor/core @capacitor/cli
npx cap init "eHazira" "com.ehazira.app" --web-dir dist
```

This creates `capacitor.config.ts` in your project root.

### Step 2: Update Capacitor Config

Edit `capacitor.config.ts`:

```typescript
import type { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'com.ehazira.app',
  appName: 'eHazira',
  webDir: 'dist',
  server: {
    // For development: load from your dev server instead of built files
    // Comment this out for production builds
    url: 'http://YOUR_LOCAL_IP:3000',
    cleartext: true,
  },
  plugins: {
    SplashScreen: {
      launchShowDuration: 2000,
      backgroundColor: '#ffffff',
    },
  },
};

export default config;
```

### Step 3: Add Native Platforms

```bash
# Build the web app first
npm run build

# Add platforms
npx cap add android
npx cap add ios
```

### Step 4: Install Required Plugins

```bash
# Geolocation (for GPS proximity)
npm install @capacitor/geolocation

# Device info (for UUID and fingerprinting)
npm install @capacitor/device

# Status bar styling
npm install @capacitor/status-bar

# Splash screen
npm install @capacitor/splash-screen

# App lifecycle (back button handling, deep links)
npm install @capacitor/app

# Google Auth for mobile
npm install @codetrix-studio/capacitor-google-auth

# Push notifications (optional, for future use)
npm install @capacitor/push-notifications

# Haptics feedback (optional, nice UX touch)
npm install @capacitor/haptics

# Sync plugins to native projects
npx cap sync
```

### Step 5: Build and Run

```bash
# Build web assets
npm run build

# Copy web assets to native projects
npx cap copy

# Open in IDE
npx cap open android   # Opens Android Studio
npx cap open ios       # Opens Xcode
```

### Development Workflow (Live Reload)

For faster development, use live reload:

```bash
# 1. Start Vite dev server
npm run dev

# 2. In capacitor.config.ts, set server.url to your local IP:
#    url: 'http://192.168.x.x:3000'

# 3. Run on device/simulator
npx cap run android
npx cap run ios
```

---

## 6. Native API Migrations

### 6.1 Geolocation

Create a utility file `src/utils/native.ts`:

```typescript
import { Capacitor } from '@capacitor/core';
import { Geolocation } from '@capacitor/geolocation';

export async function getCurrentPosition(): Promise<{ lat: number; lng: number }> {
  if (Capacitor.isNativePlatform()) {
    // Request permissions on mobile
    const permStatus = await Geolocation.requestPermissions();
    if (permStatus.location !== 'granted') {
      throw new Error('Location permission denied');
    }
    const pos = await Geolocation.getCurrentPosition({
      enableHighAccuracy: true,
      timeout: 15000,
    });
    return { lat: pos.coords.latitude, lng: pos.coords.longitude };
  } else {
    // Web fallback (existing behavior)
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        (err) => reject(err),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
      );
    });
  }
}
```

Then replace `navigator.geolocation.getCurrentPosition(...)` calls in:
- `src/components/student/AttendanceScreen.tsx`
- `src/components/teacher/AttendanceScreen.tsx`

### 6.2 Device UUID & Fingerprint

```typescript
import { Capacitor } from '@capacitor/core';
import { Device } from '@capacitor/device';

export async function getDeviceUUID(): Promise<string> {
  if (Capacitor.isNativePlatform()) {
    const info = await Device.getId();
    return info.identifier; // Native device UUID
  } else {
    // Existing web behavior
    let uuid = localStorage.getItem('device_uuid');
    if (!uuid) {
      uuid = crypto.randomUUID();
      localStorage.setItem('device_uuid', uuid);
    }
    return uuid;
  }
}

export async function getDeviceFingerprint(): Promise<string> {
  if (Capacitor.isNativePlatform()) {
    const info = await Device.getInfo();
    const data = [
      info.manufacturer,
      info.model,
      info.operatingSystem,
      info.osVersion,
      info.platform,
    ].join('|');
    return btoa(data).substring(0, 64);
  } else {
    // Existing web behavior
    const data = [
      navigator.userAgent,
      navigator.language,
      new Date().getTimezoneOffset(),
      screen.width + 'x' + screen.height,
    ].join('|');
    return btoa(data);
  }
}
```

### 6.3 Google Sign-In

Mobile Google Sign-In uses a native dialog instead of a browser popup. Update `Login.tsx`:

```typescript
import { Capacitor } from '@capacitor/core';
import { GoogleAuth } from '@codetrix-studio/capacitor-google-auth';

// In your login handler:
async function handleGoogleLogin() {
  if (Capacitor.isNativePlatform()) {
    await GoogleAuth.initialize({
      clientId: 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com',
      scopes: ['profile', 'email'],
    });
    const result = await GoogleAuth.signIn();
    const idToken = result.authentication.idToken;
    // Send idToken to backend (same as web)
    const response = await authAPI.googleLogin({
      id_token: idToken,
      device_uuid: await getDeviceUUID(),
      fingerprint_hash: await getDeviceFingerprint(),
      platform: Capacitor.getPlatform().toUpperCase(), // 'IOS' or 'ANDROID'
    });
    // ... rest is same
  } else {
    // Existing Firebase popup flow
    const result = await signInWithPopup(auth, googleProvider);
    // ...
  }
}
```

**Google Cloud Console setup required:**
- Create OAuth 2.0 credentials for Android (SHA-1 fingerprint) and iOS (Bundle ID)
- Add these to your Google Cloud project

### 6.4 WebSocket — No Changes Needed

Capacitor's WebView supports the standard `WebSocket` API. Your existing `websocket.ts` service works without modification.

### 6.5 HTTP Requests (Axios) — Minor Config

Axios works in Capacitor, but you need to update the base URL since mobile apps don't use Vite's dev proxy:

```typescript
// In api.ts, ensure the base URL points to your actual server
const API_BASE_URL = Capacitor.isNativePlatform()
  ? 'https://your-production-server.com'   // Full URL for mobile
  : (import.meta.env.VITE_API_URL || '');   // Existing web behavior
```

---

## 7. Testing on Mac

### 7.1 iOS Simulator (Xcode)

**How to open:**
```bash
npx cap open ios
```
This opens Xcode. Then:
1. Select a simulator device from the top bar (e.g., "iPhone 15 Pro")
2. Click the Play button (or Cmd+R)
3. The simulator launches with your app

**Standalone Simulator access:**
- Open Simulator app directly: `/Applications/Xcode.app/Contents/Developer/Applications/Simulator.app`
- Or: `open -a Simulator`

**Key Simulator features:**
- Location simulation: Features > Location > Custom Location (useful for testing GPS)
- Shake gesture: Device > Shake
- Screenshot: Cmd+S
- Screen recording: Right-click on simulator window

### 7.2 Android Emulator (Android Studio)

**How to open:**
```bash
npx cap open android
```
This opens Android Studio. Then:
1. Select a virtual device from the dropdown (or create one via Device Manager)
2. Click the green Play button
3. The emulator launches with your app

**Create an emulator:**
1. Android Studio > Tools > Device Manager
2. Click "Create Device"
3. Choose "Pixel 7" (or any device)
4. Select system image: "API 34" (download if needed)
5. Finish

**Key Emulator features:**
- Location simulation: Click "..." on emulator sidebar > Location > Set coordinates
- Extended controls: Camera, battery, network speed simulation
- Screenshot: Click camera icon on sidebar

### 7.3 Physical Device Testing

#### iOS (iPhone/iPad)
1. Connect iPhone via USB
2. In Xcode: select your device from the device list
3. You need an Apple Developer account (free for testing, $99/year for App Store)
4. First time: trust the developer certificate on your iPhone (Settings > General > Device Management)

#### Android
1. Enable Developer Options: Settings > About Phone > tap Build Number 7 times
2. Enable USB Debugging: Settings > Developer Options > USB Debugging
3. Connect via USB
4. Run: `npx cap run android --target YOUR_DEVICE_ID`

### 7.4 Development Tools

| Tool | Platform | Purpose |
|------|----------|---------|
| **Safari Web Inspector** | iOS | Debug WebView (Console, Network, Elements) |
| **Chrome DevTools** | Android | Debug WebView via `chrome://inspect` |
| **Capacitor Live Reload** | Both | Hot reload on device/simulator |
| **Xcode Instruments** | iOS | Performance profiling |
| **Android Studio Profiler** | Android | Memory, CPU, network profiling |

**Enable Safari Web Inspector for iOS:**
1. On Mac: Safari > Settings > Advanced > Show Develop menu
2. On iPhone/Simulator: Settings > Safari > Advanced > Web Inspector = ON
3. Open Safari on Mac > Develop > [Simulator/Device name] > Select your app's WebView

**Enable Chrome DevTools for Android:**
1. Open Chrome on your Mac
2. Go to `chrome://inspect/#devices`
3. Your app's WebView will appear under the connected device
4. Click "inspect" to open DevTools

---

## 8. Platform-Specific Considerations

### 8.1 iOS

**Info.plist permissions (auto-configured by Capacitor plugins, verify in `ios/App/App/Info.plist`):**
```xml
<!-- GPS -->
<key>NSLocationWhenInUseUsageDescription</key>
<string>eHazira needs your location to verify attendance proximity</string>
<key>NSLocationAlwaysAndWhenInUseUsageDescription</key>
<string>eHazira needs your location to verify attendance proximity</string>

<!-- Camera (if needed in future) -->
<key>NSCameraUsageDescription</key>
<string>eHazira needs camera access</string>
```

**iOS-specific notes:**
- Safe area insets: Tailwind handles this, but verify on notched devices
- Back gesture: iOS has native swipe-back; ensure React Router doesn't conflict
- Status bar: Use `@capacitor/status-bar` to style the status bar color

### 8.2 Android

**AndroidManifest.xml permissions (in `android/app/src/main/AndroidManifest.xml`):**
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
```

**Android-specific notes:**
- Hardware back button: Handle with `@capacitor/app` plugin's `backButton` listener
- WebView version: Android System WebView must be up to date for best performance
- Cleartext traffic: For development, you may need `android:usesCleartextTraffic="true"` in the manifest

### 8.3 Shared Considerations

- **Splash screen:** Configure via `@capacitor/splash-screen` plugin in `capacitor.config.ts`
- **App icon:** Place icons in `android/app/src/main/res/mipmap-*` and `ios/App/App/Assets.xcassets/AppIcon.appiconset/`
- **Status bar:** Dark/light mode should match your app's theme toggle

---

## 9. Building for Production

### 9.1 Pre-build Checklist

1. Remove `server.url` from `capacitor.config.ts` (or comment it out)
2. Set correct API base URL for production in your environment config
3. Update app version in `package.json`
4. Ensure all native permissions are declared

### 9.2 Build Web Assets

```bash
npm run build
npx cap copy
npx cap sync
```

### 9.3 iOS Release Build

1. Open Xcode: `npx cap open ios`
2. Select "Any iOS Device" as the build target
3. Product > Archive
4. In the Organizer: Distribute App > App Store Connect
5. Upload to App Store Connect, then submit for review

**Requirements:**
- Apple Developer Program membership ($99/year)
- App Store Connect account
- App screenshots and metadata

### 9.4 Android Release Build

1. Open Android Studio: `npx cap open android`
2. Build > Generate Signed Bundle / APK
3. Choose "Android App Bundle" (.aab) for Play Store
4. Create or select a keystore for signing
5. Upload to Google Play Console

**Requirements:**
- Google Play Developer account ($25 one-time fee)
- Signing keystore (keep this safe, you need it for all future updates)
- App screenshots and metadata

---

## 10. Common Issues & Troubleshooting

### Capacitor Sync Issues
```bash
# If plugins aren't detected after install
npx cap sync

# Full clean rebuild
rm -rf android/app/build ios/App/Pods
npx cap sync
```

### iOS Build Errors
```bash
# Pod install issues
cd ios/App && pod install --repo-update && cd ../..

# Clean Xcode build
# In Xcode: Product > Clean Build Folder (Cmd+Shift+K)
```

### Android Build Errors
```bash
# Gradle sync issues
cd android && ./gradlew clean && cd ..

# If Java version mismatch
java -version  # Should be 17
```

### CORS Issues on Mobile
Mobile apps don't have the same-origin restriction, but your backend might reject requests without the expected origin. Add your Capacitor app's origin to Django's CORS settings:

```python
# In Django settings.py
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",       # Web dev
    "capacitor://localhost",       # iOS Capacitor
    "http://localhost",            # Android Capacitor
]
```

### GPS Not Working in Emulator
- **iOS Simulator:** Features > Location > Custom Location
- **Android Emulator:** Extended Controls (...) > Location > Send coordinates
- Both simulators default to no location — you must set one manually for testing

### WebSocket Connection on Mobile
If using a local dev server, ensure:
1. Your Mac and phone/emulator are on the same network
2. Use your Mac's local IP (not `localhost`)
3. Firewall allows connections on port 8000

---

## Summary

| Question | Answer |
|----------|--------|
| Do I need to rewrite code? | No. ~99% code reuse with Capacitor |
| New project or same? | Same `ehazira-frontend` project |
| Testing tool for iOS on Mac? | Xcode Simulator (free with Xcode) |
| Testing tool for Android on Mac? | Android Studio Emulator (free) |
| Files to modify | 3-4 files (geolocation wrapper, device info wrapper, login flow, API base URL) |
| New files to create | 1 file (`src/utils/native.ts` for platform-aware utilities) |
| New config files | 1 file (`capacitor.config.ts`, auto-generated) |
| Auto-generated folders | `android/` and `ios/` (don't edit manually unless needed) |
| Cost to publish | Apple: $99/year, Google Play: $25 one-time |
